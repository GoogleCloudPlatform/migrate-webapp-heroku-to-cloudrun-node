name: Build & Deploy to Cloud Run

on:
  push:
    branches:
      - migrate-gcp-heroku

env:
  PROJECT_ID: ${{ secrets.PROJECT_ID }}
  REGION: ${{ secrets.REGION }}
  REPO_NAME: ${{github.repository}} # Github Repository
  REPO: ${{ secrets.REPO }} # Artifact Registry Repositiry 

  IMAGE_BASE: ${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.PROJECT_ID }}/${{ secrets.REPO }}
  COMMIT_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-22.04
    environment: gcp-dev

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: List directory contents
        run: |
          pwd
          ls -la

      - name: Authenticate to Google Cloud with WIF
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{secrets.WIF_PROVIDER}}
          service_account: ${{secrets.SERVICE_ACCOUNT}}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
    
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ secrets.ARTIFACT_DOMAIN }}
      
      # Why do we need this?
      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
      
      # Build four different Docker images with the same codebase but different commands to run when the container starts.
      # Each image should have a different CMD command, as follows:
      # - IGNITEDAPI should have command: ["npm", "start"]
      # - IGNITEDAPI_SCHEDULER  should have command: ["npm", "workers/scheduled/poc-warning.js"]
      # - IGNITEDAPI_WORKERS should have command:  ["node", "all-workers.js"]
      # - IGNITED_CHAT_STAGING  should have command: ["npm", "start"]
      - name: Build and tag all FOUR images with respective CMDs commands
        run: |
          declare -A IMAGE_CMDS=(
            ["${{ secrets.IGNITEDAPI }}"]='["npm", "start"]'
            ["${{ secrets.IGNITEDAPI_SCHEDULER }}"]='["npm", "workers/scheduled/poc-warning.js"]'
            ["${{ secrets.IGNITEDAPI_WORKERS }}"]='["node", "all-workers.js"]'
            ["${{ secrets.IGNITED_CHAT_STAGING }}"]='["npm", "start"]'
          )

          for IMAGE in "${!IMAGE_CMDS[@]}"; do
            CMD_ARG=${IMAGE_CMDS[$IMAGE]}
            echo "Building $IMAGE with CMD: $CMD_ARG"
            docker build -t $IMAGE_BASE/$IMAGE:latest -t $IMAGE_BASE/$IMAGE:$COMMIT_TAG . \
              --build-arg CMD="$CMD_ARG"
          done
      
      # Pull the active "latest" from the repository and then delete all images
      # In the nest step, we will retag the pulled "latest" to "previous"
      - name: Cleanup old images in Artifact Registry
        run: |
          IMAGES=("${{ secrets.IGNITEDAPI }}" "${{ secrets.IGNITEDAPI_WORKERS }}" "${{ secrets.IGNITEDAPI_SCHEDULER }}" "${{ secrets.IGNITED_CHAT_STAGING }}")
          for IMAGE in "${IMAGES[@]}"; do
            echo "Cleaning up old tags and untagged images for $IMAGE..."
            
            # Check if repository exists before listing tags
            if gcloud artifacts repositories describe ${{ secrets.REPO }} --location=${{ secrets.REGION }} &>/dev/null; then
              # Use 'set +e' to prevent script from failing if no tags are found
              set +e
              TAGS=$(gcloud artifacts docker tags list $IMAGE_BASE/$IMAGE --format="value(tag)" --sort-by="~createTime" 2>/dev/null)
              set -e
              KEEP_TAGS=("latest" "previous")
              
              if [ -n "$TAGS" ]; then
                # Delete all tags except for 'latest' and 'previous'
                for TAG in $TAGS; do
                  if [[ ! " ${KEEP_TAGS[*]} " == *" $TAG "* ]]; then
                    echo "Deleting tag $TAG for $IMAGE"
                    gcloud artifacts docker tags delete $IMAGE_BASE/$IMAGE:$TAG --quiet || echo "Failed to delete tag $TAG"
                  fi
                done
                
                # List and delete untagged images
                UNTAGGED_IMAGES=$(gcloud artifacts docker images list $IMAGE_BASE/$IMAGE --filter="NOT tags:*" --format="value(digest)" 2>/dev/null || echo "")
                
                if [ -n "$UNTAGGED_IMAGES" ]; then
                  for DIGEST in $UNTAGGED_IMAGES; do
                    echo "Deleting untagged image with digest $DIGEST for $IMAGE"
                    gcloud artifacts docker images delete $IMAGE_BASE/$IMAGE@$DIGEST --quiet --delete-tags || echo "Failed to delete digest"
                  done
                else
                  echo "No untagged images found for $IMAGE"
                fi
              else
                echo "No tags found for $IMAGE, skipping cleanup"
              fi
            else
              echo "Repository ${{ secrets.REPO }} does not exist yet or is not accessible, skipping cleanup for $IMAGE"
            fi
          done

      - name: Pull and retag previous latest as 'previous'
        continue-on-error: true
        run: |
          for IMAGE in ${{ secrets.IGNITEDAPI }} ${{ secrets.IGNITEDAPI_WORKERS }} ${{ secrets.IGNITEDAPI_SCHEDULER }} ${{ secrets.IGNITED_CHAT_STAGING }}; do
            if docker pull $IMAGE_BASE/$IMAGE:latest; then
              docker tag $IMAGE_BASE/$IMAGE:latest $IMAGE_BASE/$IMAGE:previous
              docker push $IMAGE_BASE/$IMAGE:previous
            else
              echo "No previous image found for $IMAGE, skipping tagging as previous"
            fi
          done

      - name: Push all built images
        run: |
          for IMAGE in ${{ secrets.IGNITEDAPI_SCHEDULER }} ${{ secrets.IGNITED_CHAT_STAGING }}; do
            echo "Pushing $IMAGE:latest and :$COMMIT_TAG"
            docker push $IMAGE_BASE/$IMAGE:latest
            docker push $IMAGE_BASE/$IMAGE:$COMMIT_TAG
          done