name: Build & Deploy to Cloud Run

# Trigger workflow on any push to the 'migrate-gcp-heroku' branch
on:
  push:
    branches:
      - migrate-gcp-heroku

env:
  # Constructs the base path for container images in Artifact Registry
  IMAGE_BASE: ${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.PROJECT_ID }}/${{ secrets.REPO }}
  # Stores the commit SHA for image traceability 
  COMMIT_TAG: ${{ github.sha }}

jobs:
  ######################################################
  # JOB 1: Build the images and deploy them to Artifact Registry repository.
  ######################################################
  build-and-push:
    # if: false 
    runs-on: ubuntu-22.04
    environment: gcp-dev

    # Request necessary permissions for the job
    permissions:
      id-token: write   # Needed for Workload Identity Federation
      contents: read    # Access to the AR repository code

    steps:
      # Step 1: Get the code from the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Debug step to show current directory and files
      - name: List directory contents
        run: |
          pwd
          ls -la
      
      # Step 3: Authenticate to GCP using Workload Identity Federation
      - name: Authenticate to Google Cloud with WIF
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{secrets.WIF_PROVIDER}}
          service_account: ${{secrets.SERVICE_ACCOUNT}}

      # Step 4: Set up the gcloud CLI tools for later GCP operations
      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
    
      # Step 5: Configure Docker to use Google Artifact Registry for pushing images
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ secrets.ARTIFACT_DOMAIN }}

      # Step 6: Generate a timestamp for tagging images
      - name: Generate timestamp tag
        id: timestamp
        run: echo "TIMESTAMP=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT
      
      
      # Step 7: Improved cleanup - keep last 2 images in Artifact Registry
      - name: Smart cleanup - keep last 2 images for each repository
        run: |
          set -e # Exit immediately if a command exits with a non-zero status
          
          # Set the correct IMAGE_BASE for Google Artifact Registry
          IMAGE_BASE="${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.PROJECT_ID }}/${{ secrets.REPO }}"
          
          IMAGES=("${{ vars.IGNITEDAPI }}" "${{ vars.IGNITEDAPI_WORKERS }}" "${{ vars.IGNITEDAPI_SCHEDULER }}" "${{ vars.IGNITED_CHAT_STAGING }}")
          IMAGES_TO_KEEP=2
          
          for IMAGE in "${IMAGES[@]}"; do
            echo "Cleaning up $IMAGE - keeping last $IMAGES_TO_KEEP images..."
            
            # Check if the repository exists before trying to delete images
            if ! gcloud artifacts repositories describe ${{ secrets.REPO }} --location=${{ secrets.REGION }} &>/dev/null; then
              echo "Repository ${{ secrets.REPO }} doesn't exist yet or is not accessible, skipping cleanup"
              continue
            fi
            
            # Get all image digests sorted by creation time (oldest first)
            DIGESTS=$(gcloud artifacts docker images list $IMAGE_BASE/$IMAGE \
                      --format="value(DIGEST),value(CREATE_TIME)" 2>/dev/null | sort -k2 | awk '{print $1}' || echo "")
            
            if [ -z "$DIGESTS" ]; then
              echo "No existing images found for $IMAGE"
              continue
            fi
            
            # Count total images
            TOTAL_IMAGES=$(echo "$DIGESTS" | wc -l)
            echo "Found $TOTAL_IMAGES existing images for $IMAGE"
            
            # Calculate how many to delete (keep the most recent ones)
            if [ $TOTAL_IMAGES -le $IMAGES_TO_KEEP ]; then
              echo "Keeping all $TOTAL_IMAGES images for $IMAGE (≤ $IMAGES_TO_KEEP)"
              continue
            fi
            
            IMAGES_TO_DELETE=$((TOTAL_IMAGES - IMAGES_TO_KEEP))
            echo "Deleting $IMAGES_TO_DELETE oldest images for $IMAGE"
            
            # Get just the oldest digests to delete
            DIGESTS_TO_DELETE=$(echo "$DIGESTS" | head -n $IMAGES_TO_DELETE)
            
            # Delete each digest
            for DIGEST in $DIGESTS_TO_DELETE; do
              echo "Deleting image with digest $DIGEST"
              if ! gcloud artifacts docker images delete $IMAGE_BASE/$IMAGE@$DIGEST --quiet --delete-tags; then
                echo "Warning: Failed to delete digest $DIGEST - continuing with other deletions"
              fi
            done
            
            echo "Cleanup completed for $IMAGE - kept $IMAGES_TO_KEEP most recent images"
          done

      # Add a step to get PR number for tagging
      - name: Get PR Number
        id: pr-number
        run: |
          # For pull requests
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "PR_NUMBER=PR-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          # For push events - use commit SHA instead of branch name
          else
            SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
            echo "PR_NUMBER=SHA-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

      # Step 8: Updated build with PR tagging and error handling
      - name: Build new images
        run: |
          set -e # Exit immediately if any command fails
          
          TIMESTAMP="${{ steps.timestamp.outputs.TIMESTAMP }}"
          PR_TAG="${{ steps.pr-number.outputs.PR_NUMBER }}"
          # Set the correct IMAGE_BASE for Google Artifact Registry
          IMAGE_BASE="${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.PROJECT_ID }}/${{ secrets.REPO }}"
          
          echo "Building images with timestamp tag: $TIMESTAMP and PR tag: $PR_TAG"
          
          # Define the CMD instructions for each container using an associative array
          declare -A IMAGE_CMDS=(
            ["${{ vars.IGNITEDAPI }}"]='["npm", "start"]'
            ["${{ vars.IGNITEDAPI_SCHEDULER }}"]='["npm", "workers/scheduled/poc-warning.js"]'
            ["${{ vars.IGNITEDAPI_WORKERS }}"]='["node", "all-workers.js"]'
            ["${{ vars.IGNITED_CHAT_STAGING }}"]='["npm", "start"]'
          )

          # Build each image with its specific CMD and multiple tags
          BUILD_SUCCESS=true
          for IMAGE in "${!IMAGE_CMDS[@]}"; do
            CMD_ARG=${IMAGE_CMDS[$IMAGE]}
            echo "Building $IMAGE with CMD: $CMD_ARG and tags: latest, $TIMESTAMP, $PR_TAG"
            
            if ! docker build -t $IMAGE_BASE/$IMAGE:latest \
                            -t $IMAGE_BASE/$IMAGE:$TIMESTAMP \
                            -t $IMAGE_BASE/$IMAGE:$PR_TAG \
                            . --build-arg CMD="$CMD_ARG"; then
              echo "::error::Failed to build image $IMAGE"
              BUILD_SUCCESS=false
            fi
          done
          
          if [ "$BUILD_SUCCESS" = false ]; then
            echo "::error::One or more image builds failed"
            exit 1
          fi

      # Step 9: Updated push with proper error handling and correct IMAGE_BASE
      - name: Push new images
        if: success() # Only run if previous steps succeeded
        run: |
          set -e # Exit immediately if any command fails
          
          TIMESTAMP="${{ steps.timestamp.outputs.TIMESTAMP }}"
          PR_TAG="${{ steps.pr-number.outputs.PR_NUMBER }}"
          # Set the correct IMAGE_BASE for Google Artifact Registry
          IMAGE_BASE="${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.PROJECT_ID }}/${{ secrets.REPO }}"
          
          PUSH_SUCCESS=true
          for IMAGE in ${{ vars.IGNITEDAPI }} ${{ vars.IGNITEDAPI_WORKERS }} ${{ vars.IGNITEDAPI_SCHEDULER }} ${{ vars.IGNITED_CHAT_STAGING }}; do
            echo "Pushing $IMAGE with tags: latest, $TIMESTAMP, $PR_TAG"
            
            # Verify repository exists before pushing
            if ! gcloud artifacts repositories describe ${{ secrets.REPO }} --location=${{ secrets.REGION }} &>/dev/null; then
              echo "::error::Repository ${{ secrets.REPO }} doesn't exist or permission denied"
              PUSH_SUCCESS=false
              continue
            fi
            
            if ! docker push $IMAGE_BASE/$IMAGE:latest; then
              echo "::error::Failed to push $IMAGE_BASE/$IMAGE:latest"
              PUSH_SUCCESS=false
            fi
            
            if ! docker push $IMAGE_BASE/$IMAGE:$TIMESTAMP; then
              echo "::error::Failed to push $IMAGE_BASE/$IMAGE:$TIMESTAMP"
              PUSH_SUCCESS=false
            fi
            
            if ! docker push $IMAGE_BASE/$IMAGE:$PR_TAG; then
              echo "::error::Failed to push $IMAGE_BASE/$IMAGE:$PR_TAG"
              PUSH_SUCCESS=false
            fi
          done
          
          if [ "$PUSH_SUCCESS" = false ]; then
            echo "::error::One or more image pushes failed"
            exit 1
          else
            echo "All images successfully pushed to Artifact Registry"
          fi

  ######################################################
  # JOB 2: Second job that depends on the first job completing
  ######################################################
  deploy:
    if: false 
    runs-on: ubuntu-22.04
    needs: build-and-push
    environment: gcp-dev

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud with WIF
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1

      # Deploy each service to Cloud Run
      - name: Deploy to Cloud Run
        continue-on-error: true   # Delete this in the production.
        run: |
          export REGION="${{ secrets.REGION }}"
          export IMAGE_BASE="${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.PROJECT_ID }}/${{ secrets.REPO }}"
          # export TIMESTAMP="${{ steps.timestamp.outputs.TIMESTAMP }}"

          IMAGES=(
            "${{ vars.IGNITEDAPI }}"
            "${{ vars.IGNITEDAPI_WORKERS }}"
            "${{ vars.IGNITEDAPI_SCHEDULER }}"
            "${{ vars.IGNITED_CHAT_STAGING }}"
          )
          
          SERVICES=(
            "${{ vars.IGNITEDAPI }}"
            "${{ vars.IGNITEDAPI_WORKERS }}"
            "${{ vars.IGNITEDAPI_SCHEDULER }}"
            "${{ vars.IGNITED_CHAT_STAGING }}"
          )

          for i in "${!SERVICES[@]}"; do
            SERVICE="${SERVICES[$i]}"
            IMAGE="${IMAGES[$i]}"

            echo "Checking if service $SERVICE exists..."
            if gcloud run services describe "$SERVICE" --region="$REGION" --platform=managed &>/dev/null; then
              echo "Service $SERVICE exists. Deploying image $IMAGE..."
              gcloud run services update "$SERVICE" \
                --image="$IMAGE_BASE/$IMAGE:latest" \
                --region="$REGION" \
                --platform=managed \
                --quiet
            else
              echo "Service $SERVICE does not exist, skipping..."
            fi
          done

  ######################################################
  # JOB 3: Conclude
  ######################################################
  finish:
    if: false 
    name: Finalize Workflow
    runs-on: ubuntu-22.04
    needs: deploy
    steps:
      - name: Workflow Complete
        run: echo "✅ Build and Deploy workflow completed successfully!"
